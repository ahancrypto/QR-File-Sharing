<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR File Sharing - Share with Ease</title>
    <link rel="icon" href="/static/favicon.png" type="image/png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f2f5;
            color: #333;
            transition: background-color 0.3s, color 0.3s;
        }
        .dark-mode {
            background-color: #1a1a1a;
            color: #f0f2f5;
        }
        .navbar {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .navbar-brand {
            font-weight: 600;
        }
        .card {
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        #dropArea {
            border: 2px dashed #6c757d;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            background-color: #ffffff;
            transition: all 0.3s ease;
        }
        #dropArea.dragover {
            background-color: #e9ecef;
            border-color: #007bff;
        }
        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }
        .btn-primary:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }
        .instruction-item {
            background-color: #f8f9fa;
            border-left: 5px solid #007bff;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        .instruction-item:hover {
            transform: translateX(10px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .footer {
            background-color: #007bff;
            color: #ffffff;
            padding: 20px 0;
            margin-top: 50px;
        }
        #author-name {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 14px;
            color: rgba(0, 0, 0, 0.5);
            pointer-events: none;
        }
        .dark-mode #author-name {
            color: rgba(255, 255, 255, 0.5);
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <img src="/static/app.png" width="30" height="30" class="d-inline-block align-top mr-2" alt="">
                QR File Sharing
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="showInstructions">
                            <i class="fas fa-info-circle"></i> Instructions
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="darkModeToggle">
                            <i class="fas fa-moon"></i> Dark Mode
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card p-4 fade-in">
                    <h3 class="card-title text-center mb-4">Upload and Share Files via QR Code</h3>
                    <div id="dropArea" class="mb-4">
                        <i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>
                        <p>Drag and drop your file here</p>
                        <p>or</p>
                        <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-folder-open"></i> Browse File
                        </button>
                        <input type="file" id="fileInput" class="d-none">
                    </div>
                    <div id="fileMetadata" class="mb-4 d-none">
                        <h5>File Details:</h5>
                        <p><strong>Name:</strong> <span id="fileName"></span></p>
                        <p><strong>Size:</strong> <span id="fileSize"></span></p>
                    </div>
                    <div id="qrCodeSection" class="text-center mb-4 d-none">
                        <h5 class="mb-3">Your QR Code:</h5>
                        <img id="qrCodeImage" src="" alt="QR Code" class="img-fluid rounded mb-3">
                        <div class="d-flex justify-content-center gap-2">
                            <a id="downloadLink" href="#" class="btn btn-success">
                                <i class="fas fa-download"></i> Download File
                            </a>
                            <button id="shareQR" class="btn btn-secondary">
                                <i class="fas fa-share-alt"></i> Copy Link
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row justify-content-center mt-5">
            <div class="col-md-10">
                <div class="card p-4 fade-in">
                    <h4 class="mb-4"><i class="fas fa-history"></i> Upload History</h4>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>File Name</th>
                                    <th>QR Code</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="historyTable">
                                <!-- Upload history populated dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="instructionModal" tabindex="-1" aria-labelledby="instructionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="instructionModalLabel"><i class="fas fa-book"></i> How to Use QR File Sharing</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="instruction-item">
                        <i class="fas fa-exclamation-triangle text-warning"></i>
                        <strong>Important:</strong> This app only works in LAN (Local Area Network).
                    </div>
                    <div class="instruction-item">
                        <i class="fas fa-file-upload text-primary"></i>
                        <strong>Step 1:</strong> Upload your file by dragging and dropping or clicking "Browse File".
                    </div>
                    <div class="instruction-item">
                        <i class="fas fa-qrcode text-success"></i>
                        <strong>Step 2:</strong> A QR code will be generated for your uploaded file.
                    </div>
                    <div class="instruction-item">
                        <i class="fas fa-mobile-alt text-info"></i>
                        <strong>Step 3:</strong> Scan the QR code with another device to access the file.
                    </div>
                    <div class="instruction-item">
                        <i class="fas fa-download text-primary"></i>
                        <strong>Step 4:</strong> Click "Download" to save the file on your device.
                    </div>
                    <div class="instruction-item">
                        <i class="fas fa-link text-secondary"></i>
                        <strong>Step 5:</strong> Use "Copy Link" to share the file link directly.
                    </div>
                    <div class="instruction-item">
                        <i class="fas fa-history text-muted"></i>
                        <strong>Step 6:</strong> Access your upload history for quick file retrieval.
                    </div>
                </div>
            </div>
        </div>
    </div>



    <div id="notification" class="toast align-items-center text-white bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="notificationMessage"></div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>

    <div id="spinner" class="position-fixed top-50 start-50 translate-middle d-none">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <p id="author-name"></p>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
	
	<script>
  
    var name = atob('QWhhbiBTYXJkYXI=');
    
    document.getElementById("author-name").textContent = name;
  </script>
   

    <!-- Footer -->
    <footer class="footer text-center">
        <div class="container">
            <span>© 2024 QR File Sharing By Ahan Sardar</span>
			
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- JavaScript -->
    <script>
        const dropArea = document.getElementById("dropArea");
        const fileInput = document.getElementById("fileInput");
        const fileMetadata = document.getElementById("fileMetadata");
        const fileName = document.getElementById("fileName");
        const fileSize = document.getElementById("fileSize");
        const qrCodeSection = document.getElementById("qrCodeSection");
        const qrCodeImage = document.getElementById("qrCodeImage");
        const downloadLink = document.getElementById("downloadLink");
        const historyTable = document.getElementById("historyTable");
		
		// Reference to modal elements
const deleteConfirmModal = new bootstrap.Modal(document.getElementById("deleteConfirmModal"));
const fileToDeleteNameElement = document.getElementById("fileToDeleteName");
const confirmDeleteButton = document.getElementById("confirmDeleteButton");
let fileRowToDelete = null; // To keep track of the row to delete

   // Function to show instructions when clicked
        document.getElementById("showInstructions").addEventListener("click", function() {
            document.getElementById("instructionPane").style.display = "block";
        });

        // Close instructions when clicked
        document.getElementById("closeInstructions").addEventListener("click", function() {
            document.getElementById("instructionPane").style.display = "none";
        });
        

        // Show notification
        function showNotification(message, type = "info") {
            const notification = document.getElementById("notification");
            notification.classList.remove("hidden");
            notification.classList.add(`alert-${type}`);
            document.getElementById("notificationMessage").textContent = message;

            setTimeout(() => {
                notification.classList.add("hidden");
            }, 5000);
        }

        // Show spinner
        function showSpinner() {
            document.getElementById("spinner").classList.remove("hidden");
            document.getElementById("spinner").style.display = "inline-block";
        }

        // Hide spinner
        function hideSpinner() {
            document.getElementById("spinner").classList.add("hidden");
            document.getElementById("spinner").style.display = "none";
        }

        // Handle file upload with spinner and notifications
        function uploadFile(file) {
           

          
            const formData = new FormData();
            formData.append("file", file);

            showSpinner();
            showNotification("Uploading file...", "info");

            fetch("/upload", {
                method: "POST",
                body: formData,
            })
            .then((response) => response.json())
            .then((data) => {
                hideSpinner();
                if (data.qr_code) {
                    document.getElementById("qrCodeImage").src = data.qr_code;
                    document.getElementById("downloadLink").href = data.download_link;
                    document.getElementById("qrCodeSection").classList.remove("hidden");
                    addHistory(file.name, data.qr_code, data.download_link);
                    saveHistoryToLocalStorage(file.name, data.qr_code, data.download_link);
                    showNotification("File uploaded successfully!", "success");
                } else {
                    showNotification("Error: QR Code not generated.", "danger");
                }
            })
            .catch((error) => {
                hideSpinner();
                showNotification("Error uploading file: " + error.message, "danger");
            });
        }

        // Copy link functionality
        document.getElementById("shareQR").addEventListener("click", () => {
            const qrLink = document.getElementById("downloadLink").href;
            copyToClipboard(qrLink);
            showNotification("Link copied to clipboard!", "info");
        });

        // Copy text to clipboard
        function copyToClipboard(text) {
            const tempInput = document.createElement("input");
            document.body.appendChild(tempInput);
            tempInput.value = text;
            tempInput.select();
            document.execCommand("copy");
            document.body.removeChild(tempInput);
        }

   // Add file to history (modified to make QR code clickable)
function addHistory(fileName, qrCodeUrl, downloadUrl) {
    const row = document.createElement("tr");
    row.innerHTML = `
                <td>${fileName}</td>
                <td><img src="${qrCodeUrl}" alt="QR Code" class="img-thumbnail qr-code" width="50" data-qrcode="${qrCodeUrl}"></td>
                <td><a href="${downloadUrl}" class="btn btn-sm btn-success">
                    <i class="fas fa-download"></i> Download
                </a></td>
                <td><button class="btn btn-sm btn-danger" onclick="deleteHistoryRow(this)">
                    <i class="fas fa-trash-alt"></i> Delete
                </button></td>
            `;
    historyTable.appendChild(row);
}

// Add event listener to open QR code in modal when clicked
document.addEventListener("click", (event) => {
    if (event.target && event.target.classList.contains("qr-code")) {
        const qrCodeUrl = event.target.getAttribute("data-qrcode");
        const modalImage = document.getElementById("enlargedQrCode");
        modalImage.src = qrCodeUrl;
        
        // Show the modal
        const qrCodeModal = new bootstrap.Modal(document.getElementById("qrCodeModal"));
        qrCodeModal.show();
    }
});


// Modify deleteHistoryRow to trigger modal
function deleteHistoryRow(button) {
    // Get the file name from the row
    const row = button.closest("tr");
    const fileName = row.cells[0].textContent;

    // Show the modal with the file name
    fileToDeleteNameElement.textContent = fileName;
    fileRowToDelete = row; // Store the row to delete when confirmed

    // Show the modal
    deleteConfirmModal.show();
}
// Function to replace spaces with underscores in file name
function translateFileName(fileName) {
    return fileName.replace(/ /g, '_');
}

// Confirm deletion
document.getElementById("confirmDeleteButton").addEventListener("click", () => {
    let fileName = fileRowToDelete.cells[0].textContent;

    // Translate file name to replace spaces with underscores
    fileName = translateFileName(fileName);

    // Make a DELETE request to the server to delete the file
    fetch(`/delete/${fileName}`, {
        method: 'DELETE',
    })
    .then((response) => response.json())
    .then((data) => {
        if (data.success) {
            // Remove the row from the table
            fileRowToDelete.remove();  

            // Delete the file from localStorage
            let history = JSON.parse(localStorage.getItem("uploadHistory")) || [];
            history = history.filter(item => item.fileName !== fileName);  // Fix reference to fileName
            localStorage.setItem("uploadHistory", JSON.stringify(history));

            // Show notification
            showNotification("Upload history deleted and file removed from the server.", "info");
        } else {
            showNotification("Error deleting file from the server.", "danger");
        }
    })
    .catch((error) => {
        showNotification("Error deleting file: " + error.message, "danger");
    });

    // Close the modal
    const modal = bootstrap.Modal.getInstance(document.getElementById("deleteConfirmModal"));
    modal.hide();
});


        // Save history to local storage
        function saveHistoryToLocalStorage(fileName, qrCodeUrl, downloadUrl) {
            let history = JSON.parse(localStorage.getItem("uploadHistory")) || [];
            history.push({ fileName, qrCodeUrl, downloadUrl });
            localStorage.setItem("uploadHistory", JSON.stringify(history));
        }

        // Load history from local storage
        function loadHistoryFromLocalStorage() {
            let history = JSON.parse(localStorage.getItem("uploadHistory")) || [];
            history.forEach(item => {
                addHistory(item.fileName, item.qrCodeUrl, item.downloadUrl);
            });
        }

        // Drop zone functionality
        dropArea.addEventListener("dragover", (event) => {
            event.preventDefault();
            dropArea.classList.add("dragover");
        });

        dropArea.addEventListener("dragleave", () => {
            dropArea.classList.remove("dragover");
        });

        dropArea.addEventListener("drop", (event) => {
            event.preventDefault();
            dropArea.classList.remove("dragover");
            const file = event.dataTransfer.files[0];
            if (file) {
                uploadFile(file);
            }
        });

        // File input change handler
        fileInput.addEventListener("change", () => {
            const file = fileInput.files[0];
            if (file) {
                uploadFile(file);
            }
        });

        // Dark mode toggle
        document.getElementById("darkModeToggle").addEventListener("click", () => {
            document.body.classList.toggle("dark-mode");
        });

        // Initialize history
        loadHistoryFromLocalStorage();
    </script>
</body>
</html>
